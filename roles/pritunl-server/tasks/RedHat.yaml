---
- name: Enable EPEL Repository on REHL 8
  dnf:
    name: ["epel-release", "elrepo-release"]
    state: latest
  become: True
  when: ansible_facts['os_family'] == 'RedHat' and ansible_facts['distribution_major_version'] == '8'

- name: Enable EPEL Repository on REHL 7
  yum:
    name: ["epel-release", "elrepo-release"]
    state: latest
  become: True
  when: ansible_facts['os_family'] == 'RedHat' and ansible_facts['distribution_major_version'] == '7'

- name: Copy out the pritunl repo file
  template:
    src: "pritunl-RedHat.j2"
    dest: /etc/yum.repos.d/pritunl-RedHat.repo

- name: Import gpg key
  shell: "{{ item }}"
  with_items:
    - gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 7568D9BB55FF9E5287D586017AE645C0CF8E292A
    - gpg --armor --export 7568D9BB55FF9E5287D586017AE645C0CF8E292A > key.tmp; sudo rpm --import key.tmp; rm -f key.tmp

- name: Installing wireguard
  dnf:
   name: ['kmod-wireguard', 'wireguard-tools']
   state: latest

- name: Installing pritunl
  dnf:
   name: "pritunl"
   state: latest

- name: Replacing openvpn for pritunl-openvpn
  dnf:
   name: "pritunl-openvpn"
   state: latest
   allowerasing: yes

- name: "Increase open file limits"
  block:
  - name: Increase open file limit
    pam_limits:
      domain: "*"
      limit_type: hard
      limit_item: nofile
      value: 64000

  - name: Increase open file limit
    pam_limits:
      domain: "*"
      limit_type: soft
      limit_item: nofile
      value: 64000

  - name: Increase open file limit
    pam_limits:
      domain: root
      limit_type: hard
      limit_item: nofile
      value: 64000

  - name: Increase open file limit
    pam_limits:
      domain: root
      limit_type: soft
      limit_item: nofile
      value: 64000
  when: pritunl_increase_open_limit_file

# - name: permit traffic in public zone for https service
#   ansible.posix.firewalld:
#     zone: "public"
#     service: https
#     permanent: yes
#     state: enabled